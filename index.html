<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Scratch å¯¦é©—å®¤ (å…¨åŠŸèƒ½çµ‚æ¥µä¿®å¾©ç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { 
            --primary: #4C97FF; --accent: #FFAB19; --danger: #FF6B6B;  
            --bg: #F7F9FC; --wood: #5D4037; --gold: #FFD54F; --paper: #FFF8E1; 
        }
        body { margin: 0; display: flex; height: 100vh; font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); overflow: hidden; }

        /* ========================
           1. æ©«å‘å·è»¸å‹•ç•«ç³»çµ±
           ======================== */
        .mission-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.7); z-index: 9000; 
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
            pointer-events: none; 
        }

        .scroll-container {
            position: fixed; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            height: 320px; 
            width: 0px;    
            display: flex; flex-direction: row; 
            align-items: center;
            transition: all 1s cubic-bezier(0.25, 1, 0.5, 1);
            pointer-events: auto;
            z-index: 10000; 
        }

        .scroll-handle {
            width: 18px; height: 110%; 
            background: linear-gradient(to right, #3E2723, var(--wood), #3E2723);
            border-radius: 10px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.4);
            position: relative; z-index: 2; flex-shrink: 0;
        }
        .scroll-handle::before, .scroll-handle::after {
            content: ''; position: absolute; left: -3px; width: 24px; height: 15px;
            background: var(--gold); border-radius: 4px;
            box-shadow: inset 1px 1px 3px rgba(255,255,255,0.5), 0 2px 3px rgba(0,0,0,0.3);
        }
        .scroll-handle::before { top: -10px; }
        .scroll-handle::after { bottom: -10px; }

        .scroll-body {
            background: var(--paper);
            height: 100%; width: 0px; overflow: hidden;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
            border-top: 4px solid #e0c090; border-bottom: 4px solid #e0c090;
            background-image: linear-gradient(90deg, rgba(0,0,0,0.03) 1px, transparent 1px);
            background-size: 20px 100%;
        }

        .scroll-container.open { width: 700px; } 
        .scroll-container.open .scroll-body { width: 100%; }

        .scroll-container.minimized {
            top: 15px !important; 
            left: 15px !important; 
            transform: translate(0, 0) !important;
            width: 290px !important; 
            height: 160px !important; 
        }
        
        .scroll-container.minimized .scroll-handle { height: 100%; width: 10px; } 
        .scroll-container.minimized .scroll-handle::before, 
        .scroll-container.minimized .scroll-handle::after { left: -3px; width: 16px; height: 6px; }
        
        .scroll-container.minimized .scroll-body {
            width: 100%;
            align-items: flex-start; 
            padding: 10px;
            background: #FFFDE7; 
            border-width: 2px;
        }

        .scroll-content { 
            opacity: 0; transition: opacity 0.5s 0.8s; width: 80%; 
            white-space: nowrap; 
        }
        .scroll-container.open .scroll-content { opacity: 1; white-space: normal; }
        .scroll-container.minimized .scroll-content { opacity: 1; white-space: normal; text-align: left; width: 100%; }

        .scroll-title { 
            font-size: 2.2em; color: #E65100; margin: 0 0 25px 0; font-weight: bold; 
            letter-spacing: 2px; text-shadow: 1px 1px 0px rgba(255,255,255,0.8);
        }
        .scroll-container.minimized .scroll-title { 
            font-size: 1.1em; margin-bottom: 8px; letter-spacing: 0; 
            display: flex; align-items: center; gap: 5px; 
        }
        
        .scroll-list { 
            list-style: none; padding: 0; 
            font-size: 1.4em; color: #3E2723; line-height: 1.8; 
            text-align: left; display: inline-block; 
            font-weight: bold;
        }
        .scroll-container.minimized .scroll-list { 
            font-size: 0.9em; line-height: 1.4; display: block; font-weight: normal; 
        }
        .scroll-list li { margin-bottom: 8px; display: flex; align-items: center; }
        .scroll-list li::before { content: 'ğŸ”¸'; margin-right: 8px; font-size: 0.8em; }
        .scroll-container.minimized .scroll-list li { margin-bottom: 3px; }
        .scroll-container.minimized .scroll-list li::before { content: 'â€¢'; margin-right: 5px; color: #FFB300; }


        /* ========================
           2. Layout & Components
           ======================== */
        .sidebar { 
            width: 320px; background: white; padding: 15px; 
            display: flex; flex-direction: column; border-right: 2px solid #E0E0E0; 
            z-index: 10; box-shadow: 4px 0 15px rgba(0,0,0,0.05);
            padding-top: 190px; 
            position: relative; box-sizing: border-box; 
        }

        .cam-wrapper {
            position: relative; width: 100%; height: 180px; 
            background: #000; border-radius: 12px; overflow: hidden; 
            border: 3px solid #FFD54F; margin-bottom: 10px; 
            display: flex; justify-content: center; align-items: center; flex-shrink: 0;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .cam-placeholder { position: absolute; text-align: center; color: #fff; display: none; width: 100%; z-index: 5; }
        .retry-btn { background: var(--primary); border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; color: white; }
        .face-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.7); color: white; padding: 8px;
            text-align: center; font-size: 0.9em; border-radius: 0 0 10px 10px;
        }

        .monitor-panel {
            background: #fff; border: 2px solid #eee; border-radius: 15px;
            padding: 15px; margin-bottom: 10px; flex-shrink: 0;
        }
        .metric-row { display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 5px; color: #555; }
        .high-stress { color: var(--danger); font-weight: bold; }
        .stress-bar-bg { height: 12px; background: #eee; border-radius: 10px; overflow: hidden; margin-top: 8px; }
        .stress-fill { height: 100%; width: 0%; background: var(--primary); transition: width 0.5s, background 0.5s; border-radius: 10px; }

        .main-area { flex: 1; position: relative; display: flex; flex-direction: column; overflow: hidden; }
        .scratch-frame { flex: 1; width: 100%; border: none; }

        .ta-panel {
            height: 350px; 
            background: white; border-top: 2px solid #E0E0E0;
            display: flex; flex-direction: column; padding: 15px;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.05); z-index: 20;
            flex-shrink: 0; box-sizing: border-box;
        }
        .ta-header { font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-size: 1.1em; flex-shrink: 0; }
        .ta-chat-box { 
            flex: 1; overflow-y: auto; 
            background: #FAFAFA; padding: 15px; border-radius: 12px; border: 2px solid #eee; 
            font-size: 0.95em; margin-bottom: 10px; min-height: 0; 
        }
        .ta-input-row { display: flex; gap: 10px; align-items: center; flex-shrink: 0; }
        .ta-input { flex: 1; padding: 10px 15px; border: 2px solid #ddd; border-radius: 25px; outline: none; height: 40px; box-sizing: border-box; font-size: 1em; }
        .ta-input:focus { border-color: var(--primary); }
        .btn-icon { background: #F0F0F0; border: none; width: 42px; height: 42px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 1.4em; flex-shrink: 0; transition: 0.2s; }
        .btn-icon:hover { background: #E0E0E0; transform: scale(1.1); }
        .btn-send { background: var(--primary); color: white; border: none; padding: 0 25px; border-radius: 25px; cursor: pointer; font-weight: bold; height: 40px; flex-shrink: 0; font-size: 1em; }
        .btn-send:hover { background: #357abd; transform: translateY(-2px); }

        .msg { margin-bottom: 10px; padding: 10px 15px; border-radius: 15px; max-width: 95%; line-height: 1.5; word-wrap: break-word; }
        .msg.ai { background: #E3F2FD; color: #1565C0; align-self: flex-start; border-radius: 15px 15px 15px 2px; }
        .msg.user { background: var(--primary); color: white; align-self: flex-end; border-radius: 15px 15px 2px 15px; }
        .msg.system { background: #FFF3E0; color: #E65100; text-align: center; font-size: 0.9em; border: 1px solid #FFE0B2; align-self: center; width: 90%; border-radius: 10px; }

        /* ========================
           4. æš–å¿ƒ AI å½ˆçª— (z-index 20000)
           ======================== */
        .empathy-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85); 
            z-index: 20000; 
            display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .empathy-box {
            background: white; width: 500px; height: 600px; max-height: 90vh; 
            border-radius: 20px; overflow: hidden; display: flex; flex-direction: column;
            box-shadow: 0 20px 60px rgba(76, 151, 255, 0.2); animation: fadeIn 0.4s;
            border: 3px solid #FFD54F;
        }
        .empathy-header { background: #FFF8E1; padding: 20px; display: flex; align-items: center; gap: 15px; border-bottom: 2px solid #FFE0B2; flex-shrink: 0; }
        .avatar-heart { font-size: 3em; } 
        .empathy-chat-area { padding: 20px; flex: 1; overflow-y: auto; background: #fff; display: flex; flex-direction: column; gap: 10px; }
        .msg.warm { background: #FFF3E0; color: #E65100; align-self: flex-start; border-radius: 15px 15px 15px 2px; }
        .empathy-input-area { padding: 15px; background: #FFFDE7; border-top: 2px solid #FFE0B2; display: flex; gap: 10px; align-items: center; flex-shrink: 0; }
        .emp-input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #FFCC80; outline: none; }
        .empathy-actions { padding: 15px; background: #fff; border-top: 1px solid #eee; display: flex; flex-direction: column; gap: 10px; flex-shrink: 0; align-items: center; }
        .btn-handoff { background: linear-gradient(135deg, #FFAB00, #FF6F00); color: white; padding: 12px 30px; border-radius: 30px; border: none; cursor: pointer; font-weight: bold; font-size: 1.1em; box-shadow: 0 4px 10px rgba(255, 111, 0, 0.3); width: 80%; transition: 0.2s; }
        .btn-close { background: transparent; color: #888; border: none; cursor: pointer; font-size: 0.9em; text-decoration: underline; }

        #capture-video, #capture-canvas { display: none; }
    </style>
</head>
<body>

    <div id="mission-overlay" class="mission-overlay"></div>

    <div id="scroll-container" class="scroll-container">
        <div class="scroll-handle left"></div>
        <div class="scroll-body">
            <div class="scroll-content">
                <div class="scroll-title">ğŸ“œ ä»Šå¤©çš„æŒ‘æˆ°ï¼šè·³è·³è²“</div>
                <ul class="scroll-list">
                    <li>æŒ‰ä¸‹ç©ºç™½éµ</li>
                    <li>å¾€ä¸Šè·³ (Y + 100)</li>
                    <li>ç­‰å¾…ä¸€ä¸‹ (0.5 ç§’)</li>
                    <li>æ‰ä¸‹ä¾† (Y - 100)</li>
                </ul>
            </div>
        </div>
        <div class="scroll-handle right"></div>
    </div>

    <div id="empathy-modal" class="empathy-modal">
        <div class="empathy-box">
            <div class="empathy-header">
                <div class="avatar-heart">ğŸ§¡</div>
                <div>
                    <h2 style="margin:0; color:#F57F17; font-size:1.4em;">æ·±å‘¼å¸ï¼Œæˆ‘åœ¨é€™è£¡</h2>
                    <small style="color:#F9A825; font-size:0.9em;">æš–å¿ƒå¤¥ä¼´</small>
                </div>
            </div>
            <div class="empathy-chat-area" id="empathy-chat"></div>
            <div class="empathy-input-area">
                <input type="text" id="emp-input" class="emp-input" placeholder="è·Ÿæˆ‘èªªèªªæ€éº¼äº†å—ï¼Ÿ" onkeypress="if(event.key==='Enter') sendEmpathyChat()">
                <button class="btn-send" style="background:#FFB74D" onclick="sendEmpathyChat()">é€å‡º</button>
            </div>
            <div class="empathy-actions">
                <button class="btn-handoff" onclick="handoverToTA()">ğŸ“¸ å¿ƒæƒ…å¥½é»äº†ï¼Œè«‹ç©æœ¨å¤§å¸«å¹«æˆ‘çœ‹ç©æœ¨</button>
                <button class="btn-close" onclick="closeEmpathy()">æˆ‘æ²’äº‹äº†ï¼Œå›å»è©¦è©¦çœ‹</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="cam-wrapper">
            <video id="video" autoplay muted playsinline></video>
            <div id="cam-error" class="cam-placeholder">
                âš ï¸ ç›¸æ©Ÿæœªå•Ÿå‹•<br><button class="retry-btn" onclick="initSystem()">é»æ“Šå•Ÿç”¨</button>
            </div>
            <div class="face-overlay">å¿ƒæƒ…: <span id="emo-val">æº–å‚™ä¸­...</span></div>
        </div>

        <div class="monitor-panel">
            <div class="metric-row"><span>ğŸ˜Ÿ è¡¨æƒ…æŒ‡æ•¸</span><span id="score-face">0%</span></div>
            <div class="metric-row"><span>ğŸ–±ï¸ æ»‘é¼ é€Ÿåº¦</span><span id="score-mouse">0%</span></div>
            <div class="metric-row"><span>âŒ¨ï¸ éµç›¤åŠ›é“</span><span id="score-key">0%</span></div>
            <hr style="border:0; border-top:2px solid #eee; margin:10px 0;">
            <div style="display:flex; justify-content:space-between; font-size:1em; font-weight:bold; color:#444;">
                <span>å£“åŠ›æŒ‡æ•¸</span><span id="stress-val">0%</span>
            </div>
            <div class="stress-bar-bg"><div id="stress-bar" class="stress-fill"></div></div>
        </div>

        <div style="font-size:0.85em; color:#888; margin-top:auto; line-height:1.5;">
            * å³ä¸‹è§’ï¼š<strong>ç©æœ¨å¤§å¸«</strong> (è§£é¡Œ)<br>
            * å£“åŠ›å¤§æ™‚ï¼š<strong>æš–å¿ƒå¤¥ä¼´</strong> (é™ªä½ èŠå¤©)
        </div>
    </div>

    <div class="main-area">
        <iframe class="scratch-frame" src="https://stretch3.github.io/" allow="autoplay; camera; microphone; display-capture"></iframe>
        
        <div class="ta-panel">
            <div class="ta-header">
                <span>ğŸ§™â€â™‚ï¸ ç©æœ¨å¤§å¸«</span>
            </div>
            <div class="ta-chat-box" id="ta-chat">
                <div class="msg ai">å—¨ï¼æˆ‘æ˜¯ç©æœ¨å¤§å¸«ã€‚å¯«ç¨‹å¼é‡åˆ°å•é¡Œå¾ˆæ­£å¸¸ï¼Œä½ å¯ä»¥æ‰“å­—å•æˆ‘ï¼Œæˆ–æ˜¯æŒ‰ç›¸æ©Ÿè®“æˆ‘çœ‹çœ‹ä½ çš„ç¨‹å¼å–”ï¼</div>
            </div>
            <div class="ta-input-row">
                <input type="file" id="sb3-upload" accept=".sb3" style="display: none;" onchange="handleFileUpload(this)">
                <button class="btn-icon" title="ä¸Šå‚³ SB3 æª”æ¡ˆè©•åˆ†" onclick="document.getElementById('sb3-upload').click()">ğŸ“‚</button>
                
                <button class="btn-icon" title="æˆªåœ–çµ¦å°å¸«çœ‹" onclick="captureAndAnalyze('TA_NORMAL')">ğŸ“¸</button>
                <input type="text" id="ta-input" class="ta-input" placeholder="å•å°å¸«å•é¡Œ..." onkeypress="if(event.key==='Enter') sendTextChat()">
                <button class="btn-send" onclick="sendTextChat()">é€å‡º</button>
            </div>
        </div>
    </div>

    <video id="capture-video"></video>
    <canvas id="capture-canvas"></canvas>

    <script>
        // â˜…â˜…â˜… Firebase è¨­å®š â˜…â˜…â˜…
        const firebaseConfig = {
            apiKey: "AIzaSyAycsCJlelXGO-vWQ-kgE5Yjk6n9YM0x4o",
            authDomain: "scratch-f5862.firebaseapp.com",
            projectId: "scratch-f5862",
            storageBucket: "scratch-f5862.firebasestorage.app",
            messagingSenderId: "13853303932",
            appId: "1:13853303932:web:a3ca5fee96dd24d87995f9",
            measurementId: "G-3YXSLPKJY1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // â˜…â˜…â˜… GAS URL â˜…â˜…â˜…
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzJpobTeEyfpB85AcYhINpl-4gA3ubLiXmI185COXN508SgTtCm838aH8agSyZNg9XH/exec"; 
        
        // â˜…â˜…â˜… å®Œæ•´ Prompts â˜…â˜…â˜…
        const TA_SYSTEM_PROMPT = `
        ä½ æ˜¯ Scratch ç©æœ¨å¤§å¸«ã€‚å°è±¡æ˜¯å°å­¸é«˜å¹´ç´šã€‚
        **æ ¸å¿ƒè¦å‰‡ï¼š**
        1. ç¦æ­¢ä¸€æ¬¡çµ¦å‡ºå®Œæ•´ç­”æ¡ˆï¼Œè«‹ä¸€æ­¥ä¸€æ­¥å¼•å°ã€‚
        2. çŸ­å›ç­”ï¼Œç”¨å•å¥çµå°¾ã€‚
        3. **ã€é•è¦æª¢æ¸¬ã€‘**ï¼š
           è«‹åˆ¤æ–·å­¸ç”Ÿçš„è¨Šæ¯æ˜¯å¦ç‚ºã€Œäº‚ç¢¼ã€ã€ã€Œç´”ç¬¦è™Ÿã€ã€ã€Œèˆ‡ç¨‹å¼å®Œå…¨ç„¡é—œçš„é–’èŠï¼ˆå¦‚å¹¾æ­²ã€ä½å“ªï¼‰ã€æˆ–ã€Œè² é¢ç™¼æ´©ã€ã€‚
           - å¦‚æœæ˜¯ï¼šè«‹ç”¨å¹½é»˜æˆ–æº«æŸ”çš„æ–¹å¼å°‡è©±é¡Œæ‹‰å›ï¼Œ**ä¸¦ä¸”**åœ¨å›ç­”çš„æœ€å¾Œé¢åŠ ä¸Šæ¨™ç±¤ï¼š <<<OFF_TOPIC>>>
           - å¦‚æœå¦ï¼šæ­£å¸¸å›ç­”ï¼Œä¸è¦åŠ æ¨™ç±¤ã€‚
        æ³¨æ„ï¼šå¦‚æœä½¿ç”¨è€…å‚³é€äº†åœ–ç‰‡ï¼Œé‚£æ˜¯ Scratch ç•«é¢çš„ã€Œæ”¾å¤§è£åˆ‡ã€æˆªåœ–ï¼Œè«‹å°ˆæ³¨æ–¼æª¢æŸ¥ç¨‹å¼é‚è¼¯æ˜¯å¦ç¬¦åˆè·³è·³è²“ä»»å‹™(ç©ºç™½éµ->Y+100->ç­‰å¾…->Y-100)ã€‚
        `;

        const EMPATHY_SYSTEM_PROMPT = `
        ä½ æ˜¯ä¸€å€‹ã€Œæš–å¿ƒå¤¥ä¼´ã€ã€‚ä½¿ç”¨è€…æ˜¯å°å­¸é«˜å¹´ç´šå­¸ç”Ÿã€‚
        **ä½ çš„æ ¸å¿ƒä»»å‹™ï¼š**
        1. **å®‰æ’«æƒ…ç·’**ï¼šç•¶å­¸ç”Ÿæ„Ÿåˆ°æŒ«æŠ˜ã€ç”Ÿæ°£æˆ–æƒ³æ”¾æ£„æ™‚ï¼Œçµ¦äºˆåŒç†å¿ƒå’Œé¼“å‹µã€‚
        2. **å¼•å°å›æ­¸**ï¼šè®“å­¸ç”Ÿé¡˜æ„å›åˆ° Scratch å­¸ç¿’ä¸­ã€‚

        **çµ•å°éµå®ˆçš„é™åˆ¶ï¼š**
        1. **å­—æ•¸é™åˆ¶**ï¼šæ¯æ¬¡å›ç­”å¿…é ˆæ§åˆ¶åœ¨ **250 å­—ä»¥å…§**ï¼ŒçŸ­å°ç²¾å¹¹ã€‚
        2. **ç¦æ­¢æ•™å­¸**ï¼šä½  **å®Œå…¨ä¸æ‡‚ç¨‹å¼**ã€‚å¦‚æœå­¸ç”Ÿå•ã€Œæ€éº¼åšï¼Ÿã€ã€ã€Œç©æœ¨æ€éº¼æ‹šï¼Ÿã€ã€ã€Œç‚ºä»€éº¼è·‘ä¸å‹•ï¼Ÿã€ï¼Œè«‹ **æ‹’çµ•å›ç­”æŠ€è¡“ç´°ç¯€**ï¼Œä¸¦å¼•å°å­¸ç”Ÿï¼šã€Œé€™å€‹æŠ€è¡“å•é¡Œè¦å›å»å•ã€ç©æœ¨å¤§å¸«ã€å–”ï¼ä»–æ‰æ˜¯å°ˆå®¶ã€‚ã€
        3. **èªæ°£**ï¼šæº«æŸ”ã€å¹½é»˜ã€åƒå¥½æœ‹å‹ä¸€æ¨£ã€‚
        `;

        const RUBRIC_GAME = `
        ã€åœ‹å°éŠæˆ²çµ„ - è©•åˆ†è¦æº–ã€‘
        1. ç¨‹å¼èªªæ˜æ–‡ä»¶ (15%)ï¼šç›®æ¨™æ¸…æ¥šã€è¦å‰‡é€£è²«ã€å‹è² æ¢ä»¶æ˜ç¢ºã€‚
        2. éŠæˆ²è¶£å‘³æ€§ (20%)ï¼šå…§å®¹è±å¯Œã€éŸ³æ•ˆç¾è¡“ç²¾ç·»ã€å…·å¸å¼•åŠ›ã€‚
        3. äº’å‹•æ“ä½œæ€§ (20%)ï¼šæ“ä½œé †æš¢ã€ä»‹é¢ç´°ç·»ã€é«”é©—å„ªè‰¯ã€‚
        4. ç¨ç‰¹å‰µæ„æ€§ (20%)ï¼šé«˜åº¦å‰µæ–°ã€å¼•ç™¼å…±é³´ã€å°è±¡æ·±åˆ»ã€‚
        5. åŠŸèƒ½å®Œæ•´æ€§ (25%)ï¼šåŠŸèƒ½å®Œæ•´ã€ç„¡éŒ¯èª¤ã€æµç¨‹é †åˆ©ã€‚
        `;

        const RUBRIC_ANIMATION = `
        ã€åœ‹å°å‹•ç•«çµ„ - è©•åˆ†è¦æº–ã€‘
        1. æ•˜äº‹è¨­è¨ˆ (5%)ï¼šåŠ‡æƒ…å®Œæ•´æµæš¢ã€è§’è‰²å ´æ™¯äº¤ä»£æ¸…æ¥šã€‚
        2. æµç¨‹èˆ‡å ´æ™¯è¦åŠƒ (10%)ï¼šè¦åŠƒå®Œæ•´ã€é †åºåˆç†ã€è§’è‰²å‹•ä½œåˆ°ä½ã€‚
        3. ç¨‹å¼è¨­è¨ˆ (30%)ï¼šçµæ§‹æ¸…æ¥šã€å‹•ç•«æ­£ç¢ºã€é‹ç”¨å¤šç¨®æ§åˆ¶ç©æœ¨ã€æµæš¢è‡ªç„¶ã€‚
        4. æ•…äº‹å‘ˆç¾ (30%)ï¼šè½‰å ´æµæš¢ã€ç¯€å¥æ¸…æ¥šã€éŸ³æ•ˆå­—å¹•ç²¾ç·»ã€‚
        5. å‰µæ„è¡¨é” (25%)ï¼šè§’è‰²å ´æ™¯é®®æ˜ã€ç•«é¢è¡¨ç¾å·§æ€ã€éŸ³æ•ˆç‰¹æ•ˆæ–°ç©ã€‚
        `;

        let state = {
            stress: 0, faceScore: 0, mouseScore: 0, keyScore: 0,
            isInterventionActive: false,
            clickCount: 0, keyPressCount: 0, mousePositions: [],
            dominantStressor: '',
            offTopicCount: 0,       
            empathyChatHistory: [], 
            taChatHistory: []       
        };

        window.onload = function() {
            const scroll = document.getElementById('scroll-container');
            const overlay = document.getElementById('mission-overlay');
            setTimeout(() => { scroll.classList.add('open'); }, 300);
            initSystem();
            setTimeout(() => {
                overlay.style.opacity = '0';
                scroll.classList.remove('open');
                scroll.classList.add('minimized');
                setTimeout(() => { overlay.style.display = 'none'; }, 500); 
            }, 3300); 
        };

        // --- è¡Œç‚ºåµæ¸¬ ---
        document.addEventListener('mousemove', (e) => {
            const now = Date.now();
            state.mousePositions.push({x: e.clientX, y: e.clientY, t: now});
            state.mousePositions = state.mousePositions.filter(p => now - p.t < 1000);
            if(state.mousePositions.length > 5) {
                let dist = 0;
                for(let i=1; i<state.mousePositions.length; i++) {
                    const p1 = state.mousePositions[i-1];
                    const p2 = state.mousePositions[i];
                    dist += Math.sqrt(Math.pow(p2.x-p1.x, 2) + Math.pow(p2.y-p1.y, 2));
                }
                if(dist > 1000) state.mouseScore = Math.min(100, state.mouseScore + 15);
                else state.mouseScore = Math.max(0, state.mouseScore - 5); 
            }
        });
        document.addEventListener('keydown', (e) => { 
            if(e.target.tagName === 'INPUT') return;
            state.keyPressCount++; 
        });
        document.addEventListener('mousedown', () => { state.clickCount++; });

        setInterval(() => {
            if(state.clickCount > 3) state.mouseScore = Math.min(100, state.mouseScore + 20);
            if(state.keyPressCount > 5) state.keyScore = Math.min(100, state.keyScore + 20);
            else state.keyScore = Math.max(0, state.keyScore - 5);
            state.clickCount = 0; state.keyPressCount = 0;
            updateMetricColor('score-mouse', state.mouseScore);
            updateMetricColor('score-key', state.keyScore);
            updateMetricColor('score-face', state.faceScore);
            state.stress = Math.max(state.faceScore, state.mouseScore, state.keyScore);
            if (state.stress === state.faceScore) state.dominantStressor = 'FACE';
            else if (state.stress === state.mouseScore) state.dominantStressor = 'MOUSE';
            else state.dominantStressor = 'KEY';
            document.getElementById('stress-val').innerText = state.stress + "%";
            const bar = document.getElementById('stress-bar');
            bar.style.width = state.stress + "%";
            if(state.stress < 50) document.getElementById('stress-bar').style.background = "#4C97FF";
            else if(state.stress < 80) document.getElementById('stress-bar').style.background = "#FFAB19";
            else document.getElementById('stress-bar').style.background = "#FF6B6B";
            if(state.stress > 80) triggerEmpathyAI(state.dominantStressor);
        }, 500); 

        function updateMetricColor(id, score) {
            const el = document.getElementById(id);
            el.innerText = score + "%";
            if(score > 50) el.classList.add('high-stress'); else el.classList.remove('high-stress');
        }

        async function initSystem() {
            const video = document.getElementById('video');
            const errorMsg = document.getElementById('cam-error');
            const emoVal = document.getElementById('emo-val');
            try {
                errorMsg.style.display = 'none';
                emoVal.innerText = "åµæ¸¬ä¸­...";
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.onloadedmetadata = () => { video.play(); };
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                await faceapi.nets.faceExpressionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                startFaceLoop();
            } catch(e) {
                console.error(e);
                errorMsg.style.display = 'block';
                emoVal.innerText = "ç„¡æ³•é–‹å•Ÿ";
            }
        }

        function startFaceLoop() {
            const video = document.getElementById('video');
            const emoVal = document.getElementById('emo-val');
            setInterval(async () => {
                if(video.paused || video.ended || state.isInterventionActive) return;
                const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 });
                const dets = await faceapi.detectAllFaces(video, options).withFaceExpressions();
                if(dets.length > 0) {
                    const exps = dets[0].expressions;
                    const top = Object.keys(exps).reduce((a,b)=>exps[a]>exps[b]?a:b);
                    const map = {neutral:"å¹³éœ ğŸ™‚", happy:"é–‹å¿ƒ ğŸ˜„", sad:"é›£é ğŸ˜¢", angry:"ç”Ÿæ°£ ğŸ˜ ", fearful:"å®³æ€• ğŸ˜¨", disgusted:"è¨å­ ğŸ˜–", surprised:"é©šè¨ ğŸ˜²"};
                    emoVal.innerText = map[top] || top;
                    emoVal.style.color = "#fff";
                    if(['sad', 'angry', 'fearful', 'disgusted'].includes(top)) state.faceScore = Math.min(100, state.faceScore + 10); 
                    else if(top === 'happy') state.faceScore = Math.max(0, state.faceScore - 10); 
                    else state.faceScore = Math.max(0, state.faceScore - 2); 
                } else {
                    emoVal.innerText = "ğŸ‘€";
                    emoVal.style.color = "#FFD54F";
                }
            }, 1000); 
        }

        // --- SB3 Upload ---
        async function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const taBox = document.getElementById('ta-chat');
            taBox.innerHTML += `<div class="msg user">ğŸ“‚ ä¸Šå‚³æª”æ¡ˆï¼š${file.name}</div>`;
            taBox.innerHTML += `<div class="msg ai">æ­£åœ¨åˆ†æ Scratch å°ˆæ¡ˆï¼Œè«‹ç¨ç­‰...</div>`;
            
            try {
                const zip = new JSZip();
                const contents = await zip.loadAsync(file);
                if (!contents.files['project.json']) {
                    throw new Error("æ‰¾ä¸åˆ° project.jsonï¼Œé€™å¯èƒ½ä¸æ˜¯æœ‰æ•ˆçš„ sb3 æª”æ¡ˆã€‚");
                }
                const projectJson = await contents.files['project.json'].async('string');
                
                const prompt = `
                é€™æ˜¯ä¸€å€‹å­¸ç”Ÿä¸Šå‚³çš„ Scratch å°ˆæ¡ˆä»£ç¢¼ (project.json)ã€‚
                
                **ä»»å‹™ç›®æ¨™ï¼š**
                1. **åˆ†é¡**ï¼šè«‹åˆ†æç¨‹å¼ç¢¼ç‰¹å¾µï¼Œåˆ¤æ–·å®ƒæ˜¯ã€ŒéŠæˆ²ã€é‚„æ˜¯ã€Œå‹•ç•«ã€ã€‚
                   - éŠæˆ²ç‰¹å¾µï¼šæœ‰åˆ†æ•¸è®Šæ•¸ã€éµç›¤æ»‘é¼ äº’å‹•å¤šã€æœ‰ç¢°æ’åµæ¸¬ã€æœ‰å‹è² æ¢ä»¶ã€‚
                   - å‹•ç•«ç‰¹å¾µï¼šå¤§é‡ä½¿ç”¨ã€Œèªªã€ã€ã€Œç­‰å¾…ã€ã€ã€Œæ»‘è¡Œã€ã€èƒŒæ™¯åˆ‡æ›ã€æ²’æœ‰å¤ªå¤šäº’å‹•ã€‚
                
                2. **è©•åˆ†**ï¼šæ ¹æ“šåˆ†é¡ï¼Œä½¿ç”¨ä¸‹æ–¹çš„è©•åˆ†è¦æº–é€²è¡Œè©•åˆ†ã€‚
                
                ${RUBRIC_GAME}
                
                ${RUBRIC_ANIMATION}
                
                **è¼¸å‡ºæ ¼å¼ï¼š**
                - **å°ˆæ¡ˆé¡å‹**ï¼š(éŠæˆ² / å‹•ç•«)
                - **ç¸½åˆ†**ï¼š(0-100)
                - **åˆ†é …è©•åˆ†**ï¼š(è«‹åˆ—å‡ºå„é …å¾—åˆ†)
                - **è©•èªèˆ‡å»ºè­°**ï¼š(è«‹çµ¦å‡ºå…·é«”å»ºè­°ï¼Œé¼“å‹µå­¸ç”Ÿ)

                **å°ˆæ¡ˆä»£ç¢¼å…§å®¹ï¼š**
                ${projectJson.substring(0, 50000)} ... (å…§å®¹éé•·æˆªæ–·)
                `;

                state.taChatHistory.push({ role: 'user', parts: [{ text: prompt }] });
                await sendToGAS(state.taChatHistory, 'TA', null);

            } catch (e) {
                console.error(e);
                taBox.innerHTML += `<div class="msg ai">âŒ æª”æ¡ˆè®€å–å¤±æ•—ï¼š${e.message}</div>`;
            }
            input.value = '';
        }

        // --- Chat Logic ---
        async function sendTextChat() {
            const input = document.getElementById('ta-input');
            const val = input.value.trim();
            if(!val) return;
            
            const taBox = document.getElementById('ta-chat');
            taBox.innerHTML += `<div class="msg user">${val}</div>`;
            taBox.scrollTop = taBox.scrollHeight;
            input.value = "";

            // â˜…â˜…â˜… éš±å½¢æŒ‡ä»¤ï¼šç¢ºä¿æ¯æ¬¡éƒ½é€²è¡Œæª¢æŸ¥ â˜…â˜…â˜…
            const instruction = "\n\n[ç³»çµ±æŒ‡ä»¤ï¼šå¦‚æœé€™å‰‡è¨Šæ¯æ˜¯äº‚ç¢¼ã€ç¬¦è™Ÿæˆ–é–’èŠï¼Œè«‹åœ¨å›æ‡‰æœ€å¾ŒåŠ ä¸Š <<<OFF_TOPIC>>>]";
            
            let messageText = val;
            if (state.taChatHistory.length === 0) {
                messageText = TA_SYSTEM_PROMPT + "\n\nå­¸ç”Ÿå•ï¼š" + val + instruction;
            } else {
                messageText = val + instruction;
            }

            state.taChatHistory.push({ role: 'user', parts: [{ text: messageText }] });
            await sendToGAS(state.taChatHistory, 'TA', null);
        }

        // â˜…â˜…â˜… æ ¸å¿ƒå‡½å¼ï¼šç™¼é€ GAS ä¸¦å­˜å…¥ Firestore (åªå­˜ Base64) â˜…â˜…â˜…
        async function sendToGAS(history, type, currentImageBase64) {
            
            // 1. å­˜å…¥ Firestore (åŒ…å«åœ–ç‰‡ Base64ï¼Œå¦‚æœä¸å¤ªå¤§çš„è©±)
            try {
                let docData = {
                    type: type,
                    history: history.slice(-2), // åªå­˜æœ€å¾Œå…©ç­†ï¼Œçœç©ºé–“
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // å¦‚æœæœ‰åœ–ç‰‡ï¼Œå˜—è©¦å­˜å…¥
                if (currentImageBase64) {
                    docData.imageBase64 = currentImageBase64; 
                }

                await db.collection("chat_logs").add(docData);
            
            } catch(e) {
                console.warn("Firestore save failed (likely data too large), but continuing AI request.", e);
            }

            // 2. æº–å‚™çµ¦ GAS çš„ç˜¦èº« Payload (åªç•™æ–‡å­— + ç•¶ä¸‹é€™å¼µåœ–)
            const lightweightHistory = history.map(item => {
                const parts = item.parts.map(part => {
                    if (part.inline_data) return { text: "[Image History]" };
                    return part;
                });
                return { role: item.role, parts: parts };
            });

            if (currentImageBase64) {
                const lastMsgIndex = lightweightHistory.length - 1;
                if (lightweightHistory[lastMsgIndex].role === 'user') {
                    lightweightHistory[lastMsgIndex].parts.push({
                        inline_data: { mime_type: "image/jpeg", data: currentImageBase64 }
                    });
                }
            }

            const payload = { contents: lightweightHistory };

            // 3. ç™¼é€çµ¦ GAS
            try {
                const res = await fetch(GAS_URL, {
                    method: 'POST', 
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                let reply = data.candidates[0].content.parts[0].text;

                if (type === 'TA') {
                    // â˜…â˜…â˜… æ¢å¾© OFF_TOPIC æª¢æŸ¥é‚è¼¯ â˜…â˜…â˜…
                    if (reply.includes("<<<OFF_TOPIC>>>")) {
                        state.offTopicCount++;
                        reply = reply.replace("<<<OFF_TOPIC>>>", ""); 
                        console.log(`[AIåµæ¸¬] é•è¦å…§å®¹ï¼Œç´¯ç©æ¬¡æ•¸ï¼š${state.offTopicCount}`);

                        if (state.offTopicCount >= 3) {
                            const taBox = document.getElementById('ta-chat');
                            taBox.innerHTML += `<div class="msg ai">${marked.parse(reply)}</div>`;
                            taBox.scrollTop = taBox.scrollHeight;
                            
                            setTimeout(() => { triggerEmpathyAI('BOREDOM'); }, 1500);
                            state.taChatHistory.push({ role: 'model', parts: [{ text: reply }] });
                            return; 
                        }
                    } else {
                        state.offTopicCount = 0;
                    }
                    const taBox = document.getElementById('ta-chat');
                    taBox.innerHTML += `<div class="msg ai">${marked.parse(reply)}</div>`;
                    taBox.scrollTop = taBox.scrollHeight;
                    state.taChatHistory.push({ role: 'model', parts: [{ text: reply }] });
                } else {
                    addEmpathyMsg('warm', marked.parse(reply));
                }
            } catch(e) {
                console.error("GAS Error:", e);
                if (type === 'TA') {
                    document.getElementById('ta-chat').innerHTML += `<div class="msg ai">é€£ç·šéŒ¯èª¤ (è«‹æª¢æŸ¥ GAS éƒ¨ç½²æ¬Šé™)ã€‚</div>`;
                    state.taChatHistory.pop();
                } else {
                    addEmpathyMsg('warm', "ç¶²è·¯æœ‰é»å¡å¡çš„...");
                }
            }
        }

        // ==========================================
        // 5. æš–å¿ƒ AI
        // ==========================================
        function triggerEmpathyAI(reason) {
            state.isInterventionActive = true;
            state.faceScore = 50; state.mouseScore = 0; state.keyScore = 0;
            state.offTopicCount = 0; 
            state.empathyChatHistory = [];
            
            const chatBox = document.getElementById('empathy-chat');
            chatBox.innerHTML = ''; 

            let openingMsg = "";
            if (reason === 'BOREDOM') {
                openingMsg = "å˜¿ï¼æˆ‘ç™¼ç¾æˆ‘å€‘å¥½åƒèŠé–‹äº†ï½ğŸ˜† <br>é›–ç„¶èŠå¤©å¾ˆé–‹å¿ƒï¼Œä½†æˆ‘æ˜¯ä¸æ˜¯è®“ä½ è¦ºå¾—å¯«ç¨‹å¼æœ‰é»ç„¡èŠï¼Ÿ<br>å…¶å¯¦å­¸æœƒé€™å€‹ï¼Œä½ å¯ä»¥åšè¶…é…·çš„éŠæˆ²çµ¦æœ‹å‹ç©å–”ï¼è¦ä¸è¦è©¦è©¦çœ‹ï¼Ÿ";
            } else {
                if (reason === 'FACE') openingMsg = "ä½ çœ‹èµ·ä¾†æœ‰é»å›°æ“¾ï¼Œæ˜¯ä¸æ˜¯ç¨‹å¼å¡é—œäº†ï¼Ÿ";
                else if (reason === 'MOUSE') openingMsg = "æˆ‘ç™¼ç¾ä½ çš„æ»‘é¼ ç§»å‹•å¾—æœ‰é»æ€¥ï¼Œæ˜¯ä¸æ˜¯å¿ƒè£¡æœ‰é»è‘—æ€¥ï¼Ÿ";
                else if (reason === 'KEY') openingMsg = "æ•²éµç›¤çš„åŠ›é“æœ‰é»å¤§å–”ï¼Œæ‰‹æœƒç— çš„ï¼Œæˆ‘å€‘ä¼‘æ¯ä¸€ä¸‹ã€‚";
                else openingMsg = "æ„Ÿè¦ºä½ ç¾åœ¨å£“åŠ›æœ‰é»å¤§ï¼Œæˆ‘å€‘å…ˆæ·±å‘¼å¸ã€‚";
            }

            openingMsg += "<br>(ä½ å¯ä»¥è·Ÿæˆ‘èªªèªªä½ çš„æƒ³æ³•)";
            addEmpathyMsg('warm', openingMsg);
            document.getElementById('empathy-modal').style.display = 'flex';
        }

        function addEmpathyMsg(type, text) {
            const box = document.getElementById('empathy-chat');
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = text;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            state.empathyChatHistory.push({ role: type === 'warm' ? 'model' : 'user', parts: [{ text: text }] });
        }

        async function sendEmpathyChat() {
            const input = document.getElementById('emp-input');
            const val = input.value.trim();
            if(!val) return;
            
            addEmpathyMsg('user', val);
            input.value = "";

            const history = [ { role: 'user', parts: [{ text: EMPATHY_SYSTEM_PROMPT }] }, ...state.empathyChatHistory ];
            await sendToGAS(history, 'EMPATHY', null);
        }

        function closeEmpathy() {
            document.getElementById('empathy-modal').style.display = 'none';
            state.offTopicCount = 0; 
            setTimeout(() => { state.isInterventionActive = false; }, 5000);
        }

        function handoverToTA() {
            document.getElementById('empathy-modal').style.display = 'none';
            const taBox = document.getElementById('ta-chat');
            taBox.innerHTML += `<div class="msg system">âœ¨ æš–å¿ƒå¤¥ä¼´å·²é€šçŸ¥ç©æœ¨å¤§å¸«...</div>`;
            state.offTopicCount = 0; 
            captureAndAnalyze('TA_STRESSED_' + state.dominantStressor);
            setTimeout(() => { state.isInterventionActive = false; }, 5000);
        }

        async function captureAndAnalyze(mode) {
            const taBox = document.getElementById('ta-chat');
            if(mode.includes('TA')) {
                taBox.innerHTML += `<div class="msg user">ğŸ“¸ å‚³é€æˆªåœ–ä¸­...</div>`;
            }

            let stream = null; 

            try {
                stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { cursor: "never" }, audio: false, preferCurrentTab: true
                });
                
                const videoEl = document.getElementById('capture-video');
                videoEl.srcObject = stream;
                await new Promise(r => videoEl.onloadedmetadata = r);
                videoEl.play();
                await new Promise(r => setTimeout(r, 500)); 

                const canvas = document.getElementById('capture-canvas');
                
                // â˜…â˜…â˜… è£åˆ‡èˆ‡ç¸®åœ–é‚è¼¯ â˜…â˜…â˜…
                const w = videoEl.videoWidth;
                const h = videoEl.videoHeight;
                const cropX = w * 0.20; const cropY = h * 0.10; 
                const cropW = w * 0.45; const cropH = h * 0.80; 

                let finalW = cropW; let finalH = cropH;
                if (finalW > 640) { // é™åˆ¶æœ€å¤§å¯¬åº¦ç‚º 640px
                    const scale = 640 / finalW; 
                    finalW = 640; 
                    finalH = cropH * scale; 
                }

                canvas.width = finalW; canvas.height = finalH;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(videoEl, cropX, cropY, cropW, cropH, 0, 0, finalW, finalH);
                
                // â˜…â˜…â˜… å£“ç¸®åœ–ç‰‡å“è³ªç‚º 0.4ï¼Œç¢ºä¿ Base64 å¤ å° â˜…â˜…â˜…
                const base64 = canvas.toDataURL('image/jpeg', 0.4);
                const cleanBase64 = base64.split(',')[1];

                let userPrompt = "é€™æ˜¯æˆ‘ç›®å‰çš„ç¨‹å¼ç©æœ¨ï¼Œè«‹ä¸€æ­¥ä¸€æ­¥æ•™æˆ‘ï¼Œä¸€æ¬¡åªè¬›ä¸€å€‹è§€å¿µã€‚";
                if (mode.startsWith('TA_STRESSED')) {
                    const reason = mode.split('_')[2]; 
                    userPrompt = `(æš–å¿ƒæ¨¡å¼å•Ÿå‹•ï¼šå­¸ç”Ÿå‰›å‰›å› ç‚º ${reason} æ„Ÿåˆ°æŒ«æŠ˜) è«‹éå¸¸æº«æŸ”åœ°å¹«æˆ‘çœ‹çœ‹ï¼Œä¸€æ¬¡åªæ”¹ä¸€å€‹åœ°æ–¹å°±å¥½ã€‚`;
                }

                if (state.taChatHistory.length === 0) {
                    userPrompt = TA_SYSTEM_PROMPT + "\n\n" + userPrompt;
                }

                // å­˜å…¥ History (åªå­˜æ–‡å­—ï¼Œåœ–ç‰‡å‹•æ…‹æ›è¼‰)
                state.taChatHistory.push({
                    role: 'user',
                    parts: [ { text: userPrompt } ]
                });

                // å‘¼å« GASï¼Œå¸¶ä¸Šæœ€æ–°çš„æˆªåœ– Base64
                await sendToGAS(state.taChatHistory, 'TA', cleanBase64);

            } catch(e) {
                console.error(e);
                if(mode.includes('TA')) taBox.innerHTML += `<div class="msg ai">âš ï¸ æˆªåœ–å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚</div>`;
            } finally {
                if (stream) { stream.getTracks().forEach(track => track.stop()); }
                const videoEl = document.getElementById('capture-video');
                videoEl.srcObject = null;
            }
        }
    </script>
</body>
</html>
